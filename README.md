# iaifun Telegram Bot — как запустить (очень просто)

Этот проект — Telegram‑бот для оформления предподписки (15$) и доступа в приватный канал. Есть:
- основной бот для пользователей;
- админ‑бот со статистикой;
- (по желанию) небольшой сервер для получения вебхуков от платёжной системы (для фиатных платежей).

Если вы «не сильно шарите» в программировании — не страшно. Следуйте шагам ниже.

---

## Что нужно установить заранее
1) Node.js 18+ (актуальная LTS версия). Скачать: https://nodejs.org
2) Аккаунт в Telegram.
3) Redis (база данных). Варианты:
   - самый простой — бесплатный облачный Redis (например, Redis Cloud) — получите URL подключения;
   - либо локально (Docker: `docker run -p 6379:6379 redis`).
4) (Опционально для фиата) Домен + SSL‑сертификаты, если хотите принимать уведомления от платёжки (Lava):
   - положите файлы сертификатов в папку `env_data`: `./env_data/privkey.pem` и `./env_data/fullchain.pem`.
5) (Опционально для платежей) Аккаунты и ключи в:
   - Crypto‑платежи: 0xprocessing (PAYMENT_API — ключ/токен, если требуется);
   - Фиат‑платежи: Lava (LAVA_PAYMENT_API, настройки вебхуков).

---

## Как подготовить Telegram‑бота и канал
1) В Telegram у @BotFather создайте бота и получите токен — это `BOT_TOKEN` (и при желании отдельный `BOT_TOKEN_ADMIN` для админ‑бота).
2) Создайте приватный канал, куда бот будет приглашать пользователей.
3) Добавьте вашего бота в этот приватный канал как администратора.
4) Узнайте ID канала (`PRIVATE_CHANNEL_ID`). Это число вида `-100xxxxxxxxxx`. Как получить:
   - добавьте бота @userinfobot или используйте любой «get id» бот и перешлите туда сообщение из канала;
   - либо используйте ботов/бот‑клиентов по поиску «get channel id».
5) Узнайте свой Telegram ID (для админ‑бота) через @userinfobot и добавьте его в список админов в файле `src/config.js` в массив `GLOBAL_CONFIG.admins`.

---

## Создаём файл .env
В корне проекта создайте файл `.env` со значениями. Пример:

```
# Основной бот
BOT_TOKEN=1234567890:ABCdefYourTokenHere
BOT_NAME=iaifun_bot            # Юзернейм бота без @ (нужно для формирования ссылок)
PRIVATE_CHANNEL_ID=-1001234567890
SUPPORT_USERNAME=your_support  # Юзернейм поддержки без @

# Redis (обязательно)
REDIS_URL=redis://default:password@your-redis-host:6379/0
# Примеры:
# локально без пароля: redis://127.0.0.1:6379/0
# Redis Cloud: redis://default:<PWD>@<HOST>:<PORT>

# Крипто‑платежи (0xprocessing)
PAYMENT_API=your_0xprocessing_api_key_or_token

# Фиат‑платежи (Lava)
LAVA_PAYMENT_API=your_lava_api_key

# Базовая авторизация для вебхука (фиат)
WEBHOOK_USERNAME=webhook_user
WEBHOOK_PASSWORD=webhook_pass
# Секрет для проверки подписи от платёжной системы (MD5):
WEBHOOK_PASSWORD_PROCESSING=super_secret_string

# Админ‑бот (опционально)
BOT_TOKEN_ADMIN=1234567890:ADMINbotTokenHere
```

Подсказки:
- BOT_NAME — это имя бота без @ (например, если в Telegram ваш бот `@iaifun_bot`, то BOT_NAME=iaifun_bot).
- SUPPORT_USERNAME — ник поддержки без @ (кнопки «Написать в поддержку» внутри бота используют это поле).

---

## Установка зависимостей
Откройте терминал в папке проекта и выполните:

```
npm install
```

---

## Как запустить сервер вебхуков (только если используете фиат‑платежи)
1) Запустите сервер:
```
pm2 start ./src/backend/index.js
```

## Обновление бота:
1) Подключится к серверу
2) Перейти в папку репозитория
```
cd academy_aiviral_telegram_bot/
```
3) Получить последнее обновление
```
git pull
```
4) Перезапустить бота
```
pm2 restart 0
```
---

## Где менять цены и валюты
- Файл `src/config.js`: массив `GLOBAL_CONFIG.prices` (цены/планы) и `supportedCrypto` (поддерживаемые сети/монеты).
- Список админов — там же: `GLOBAL_CONFIG.admins`.
Меняйте аккуратно, лучше сначала сделать резервную копию файла.

---

## Частые ошибки и решения
- Процесс сразу завершается без сообщений:
  - проверьте, что в `.env` задан `BOT_TOKEN` (в `src/bot_start.js` при отсутствии токена процесс завершится).
- Бот не может пригласить в канал:
  - убедитесь, что бот добавлен администратором в приватный канал и `PRIVATE_CHANNEL_ID` указан верно.
- Подключение к Redis не работает:
  - проверьте `REDIS_URL` и доступность хоста/порта; для облачного Redis проверьте корректность логина/пароля.
- Ошибка при запуске backend: нет файлов сертификатов `privkey.pem`/`fullchain.pem`:
  - создайте папку `env_data` и положите туда сертификаты; для локальных тестов можно использовать самоподписанные.
- Логи не пишутся или ошибка создания файла лога:
  - создайте папку `logs` в корне проекта.

---

## Структура проекта (вкратце)
- `src/bot_start.js` — основной бот (Telegraf).
- `src/bot_start_admin.js` — админ‑бот (показывает статистику; доступен только ID из `GLOBAL_CONFIG.admins`).
- `src/backend/index.js` — HTTPS‑сервер для приёма вебхуков (фиат‑платежи, Lava).
- `src/services/*` — работа с оплатами (крипто/фиат), пользователями, заказами, промокодами.
- `src/screens/*` — экраны/сообщения бота.
- `src/redis.js` — подключение к Redis (использует `REDIS_URL`).
- `src/config.js` — тексты, цены, настройки поддерживаемых валют и список админов.

---

## Полезно знать
- Бот запускается через long polling (без Telegram‑вебхуков), поэтому отдельный HTTP‑сервер для бота не нужен.
- Backend (HTTPS на 3000) нужен только для приёма уведомлений от платёжной системы по фиату.
- Все настройки лежат в `.env` и в `src/config.js`.

Если что‑то не получается — начните с проверки `.env` и подключений (Redis, токены бота), затем смотрите логи в консоли и файлы в `logs/`.
